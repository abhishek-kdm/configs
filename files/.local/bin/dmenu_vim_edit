#!/bin/sh

# exit on error.
set -e

readonly local current_window=$(xdotool getwindowfocus)

PROJECTS_DIR="$HOME"
PROMPT=""
DIRMODE=false
EMBED=false
DMENU_ARGS=""

while [ $# -gt 0 ]; do
  case $1 in
    -p|--prompt)
      PROMPT="$2";shift;shift;;
    -d|--dirmode)
      DIRMODE=true;shift;;
    -e|--embed)
      EMBED=true;
      DMENU_ARGS="-w $current_window"; shift;;
    *)
      PROJECTS_DIR=$1
      shift
      ;;
  esac
done

dirmode_search()
{
  cd $PROJECTS_DIR
  dir=$(
    ls -d */ \
      | dmenu -p "${PROMPT:-"edit :"}" -g 1 -l 5 ${DMENU_ARGS:-} 2> /dev/null
  )
  echo "$PROJECTS_DIR/$dir"
}

file_search()
{
  local dir=$PROJECTS_DIR
  while true; do
    file=$(
      ls $dir \
        | dmenu -p "${PROMPT:-"open :"}" -g 1 -l 5 ${DMENU_ARGS:-} 2> /dev/null
    )
    if [ -f "$dir/$file" ];
    then
      echo "$dir/$file"
      break
    elif [ -d "$dir/$file" ];
    then
      dir="$dir/$file"
    fi
  done
}

if $DIRMODE; then project_path=$(dirmode_search); else project_path=$(file_search); fi
# This is in case we wanna open a single file.
[ -f $project_path ] && dir_path=$(dirname $project_path)

COMMAND="vi --cmd \"cd ${dir_path:-$project_path}\" $project_path"

if $EMBED; then
  echo $COMMAND | xclip -i
  xdotool key --window $current_window --delay 50 Shift+Insert Return
else
  $(echo $COMMAND | xargs ${TERMINAL:-st} -e) &
fi

