#!/bin/sh

# exit on error.
set -e

readonly local current_window=$(xdotool getwindowfocus)

PROMPT=""
PROJECTS_DIR=""
DIRMODE=false
EMBED=false
DMENU_ARGS=""

if [ $# -eq 0 ]; then
  echo "The Force is not strong with this one!."
  exit 1;
fi

while [ $# -gt 0 ]; do
  case $1 in
    -p|--prompt)
      PROMPT="$2";shift;shift;;
    -d|--dirmode)
      DIRMODE=true;shift;;
    -e|--embed)
      EMBED=true;
      DMENU_ARGS="-w $current_window"; shift;;
    *)
      [ -z $PROJECTS_DIR ] && PROJECTS_DIR=$1 || exit 1
      shift
      ;;
  esac
done

dirmode_search()
{
  while true; do
    dir=$(
      ls $PROJECTS_DIR \
        | dmenu -p "${PROMPT:-"edit :"}" -g 1 -l 5 ${DMENU_ARGS:-} 2> /dev/null
    )
    if [ -d "$PROJECTS_DIR/$dir" ]; then echo "$PROJECTS_DIR/$dir"; break; fi
  done
}

file_search()
{
  local dir=$PROJECTS_DIR
  while true; do
    file=$(
      ls $dir \
        | dmenu -p "${PROMPT:-"open :"}" -g 1 -l 5 ${DMENU_ARGS:-} 2> /dev/null
    )
    if [ -f "$dir/$file" ];
    then
      echo "$dir/$file"
      break
    elif [ -d "$dir/$file" ];
    then
      dir="$dir/$file"
    fi
  done
}

if $DIRMODE; then project_path=$(dirmode_search); else project_path=$(file_search); fi
# This is in case we wanna open a single file.
[ -f $project_path ] && dir_path=$(dirname $project_path)

COMMAND="nvim -c \"cd ${dir_path:-$project_path}\" $project_path"

if $EMBED; then
  echo $COMMAND | xclip -i
  xdotool key --window $current_window --delay 50 Shift+Insert Return
else
  eval "${TERMINAL:-st} -e $COMMAND &" > /dev/null 2> /dev/null
fi

